# Lab7_12012505_占陈郅

### Lab results and analysis

#### Problem 1

> (MATLAB Exercise) Write a MATLAB program to perform LPC analysis on a frame ofspeech and to display (on a single page) the following quantities:
>
> - the original speech signal for the specified frame
> - the LPC error signal for the specified frame
> - the signal short-time Fourier transform log magnitude spectrum (dB) along with theLPC spectrum for the specified frame
> - the error signallog magnitude spectrum
>
> To test your code, use the file test_16k .wav with the following frame parameters:
>
> - starting sample:6000
> - frame size:640 samples
> - LPC order:12

The task is to compare the spectrum similarity of autocorrelation  method. According to page 7 in slide 7, H(z) is the reconstruction of spectrum  without excitation signal. Therefore, it should show the same formants with the  spectrum obtained by DFT.

Code

```matlab
% Load speech signal
[speech,fs] = audioread('test_16k.wav');

% Define frame length and overlap
frame_length = 0.03; % 30 ms
overlap = 0.5; % 50%

% Convert frame length and overlap to samples
frame_length_samples = 640;
overlap_samples = round(overlap*frame_length_samples);

% Define start and end samples of frame
start_sample = 6000;
end_sample = start_sample + frame_length_samples - 1;

% Extract frame of speech
speech_frame = speech(start_sample:end_sample);

% Perform LPC analysis on frame
p = 12; % LPC order
[a,g] = lpc(speech_frame,p);

% Generate LPC error signal
lpc_error = filter(a,1,speech_frame);

% Compute short-time Fourier transform log magnitude spectrum (dB)
window = hamming(frame_length_samples);
nfft = 2^nextpow2(frame_length_samples);
[S,F0,T1] = spectrogram(speech_frame,window,overlap_samples,nfft,fs);
S_log_mag = 20*log10(abs(S));

% Compute LPC spectrum
[H,F1] = freqz(sqrt(g),a,nfft,fs);
H_log_mag = 20*log10(abs(H));

% Compute error signal log magnitude spectrum
[E,F2,T2] = spectrogram(lpc_error,window,overlap_samples,nfft,fs);
E_log_mag = 20*log10(abs(E));

% Plot all quantities on a single page
figure;
subplot(3,2,1);
plot(speech_frame);
title('Original Speech Signal');
xlabel('Sample');
ylabel('Amplitude');
subplot(3,2,2);
plot(lpc_error);
title('LPC Error Signal');
xlabel('Sample');
ylabel('Amplitude');
subplot(3,2,3);
imagesc(T1,F0,S_log_mag);
axis xy;
title('STFT Log Magnitude Spectrum');
xlabel('Time (s)');
ylabel('Frequency (Hz)');
subplot(3,2,4);
plot(F1,H_log_mag);
title('LPC Spectrum');
xlabel('Frequency (Hz)');
ylabel('Magnitude (dB)');
subplot(3,2,5);
imagesc(T2,F2,E_log_mag);
axis xy;
title('Error Signal Log Magnitude Spectrum');
xlabel('Time (s)');
ylabel('Frequency (Hz)');
```

![1](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB7\1.png)

In the third picture, the blue line is the spectrum of LPC when p = 12. 

Since the order of the LPC method directly determines the number of poles, which is the same as the number of peaks, increasing the order can have a better result. As shown below,  the curves has more same values when the order comes to 64.

![2](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB7\2.png)



#### Problem 2

The task is to resynthesize the signal using autocorrelation method with linear prediction coefficients. This need frame by frame calculation of the coefficients and error signal. Then, according the linear assumption of the vocal  system, and the assumption of autocorrelation method that s(m) is only non-zero in 0<m<L-1.

Code

```matlab
% Load speech signal
[speech,fs] = audioread('s5.wav');

% Define frame length and overlap
frame_length = 0.04; % 40 ms
overlap = 0.75; % 75%

% Convert frame length and overlap to samples
frame_length_samples = round(frame_length*fs);
overlap_samples = round(overlap*frame_length_samples);

% Define LPC order
p = 12;

% Initialize variables for resynthesized speech signal
resynthesized = zeros(length(speech),1);
excitation = zeros(length(speech),1);

% Loop through frames of speech signal
for n = 1:overlap_samples:length(speech)-frame_length_samples+1
    
    % Extract frame of speech
    speech_frame = speech(n:n+frame_length_samples-1);
    
    % Perform LPC analysis on frame
    [a,g] = lpc(speech_frame,p);
    
    % Generate LPC error signal
    lpc_error = filter(a,1,speech_frame);
    
    % Save LPC error signal to appropriate location in resynthesized signal
    resynthesized(n:n+frame_length_samples-1) = resynthesized(n:n+frame_length_samples-1) + lpc_error;
    
    % Generate excitation signal from LPC error signal
    excitation(n:n+frame_length_samples-1) = lpc_error;
    
end

% Plot original speech signal, error signal, and resynthesized speech signal
figure;
subplot(3,1,1);
plot(speech);
title('Original Speech Signal');
xlabel('Sample');
ylabel('Amplitude');
subplot(3,1,2);
plot(excitation);
title('LPC Error Signal (Excitation)');
xlabel('Sample');
ylabel('Amplitude');
subplot(3,1,3);
plot(resynthesized);
title('Resynthesized Speech Signal');
xlabel('Sample');
ylabel('Amplitude');
```

After generating the frame error and resynthesized signal, we need to use overlap addition to add it on the whole error and resynthesized signal. Another point to mention is the hamming window of the frame signal. This is to reduce the side effect of the error signal, since the error is larger near m = 0 and m = L.

![3](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB7\3.png)

<center>frame size = 40ms, frame shift = 30ms, p = 12</center>

The result shows a pretty good similarity between the resynthesized signal and the original  one. When listening to the resynthesized one, the words can be clearly recognized, and the  tones and voices are remained. The only difference is a little bit saw could be heard. 

An interesting fact is that the error signal seems to have more similarity, and when listening  to the error signal, it is even clearer than resynthesized signal.

![4](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB7\4.png)

<center>frame size = 40ms, frame shift = 30ms, p = 128</center>

But when p increases, the error signal shows less similarity, and the resynthesized signal  becomes smaller in Amplitude.



#### Problem 3

> Vowel Cross synthesize: 
>
> 1. Perform LPC analysis on the given speech  file “vowel_iy_100hz.wav” and the vowel  /i/ you recorded in lab 2. 
> 2. Then cross synthesize by using one’s e[n]  but the other’s LPC coefficients.
> 3. Save the wav files of cross synthesized  vowels and attach them with lab report

Result wav files are attached with lab report.

Code

```matlab
% Load speech signals
[speech1,fs1] = audioread('vowel_iy_100hz.wav');
[speech2,fs2] = audioread('i.wav');

% Define frame length and overlap
frame_length = 0.03; % 30 ms
overlap = 0.5; % 50%

% Convert frame length and overlap to samples
frame_length_samples = round(frame_length*fs1);
overlap_samples = round(overlap*frame_length_samples);

% Define start and end samples of frame
start_sample = 1;
end_sample = start_sample + frame_length_samples - 1;

% Extract frame of speech1
speech1_frame = speech1(start_sample:end_sample);

% Perform LPC analysis on speech1 frame
p = 12; % LPC order
[a1,g1] = lpc(speech1_frame,p);

% Extract frame of speech2
speech2_frame = speech2(start_sample:end_sample);

% Perform LPC analysis on speech2 frame
[a2,g2] = lpc(speech2_frame,p);

% Generate LPC error signal for speech1
lpc_error1 = filter(a1,1,speech1_frame);

% Generate LPC error signal for speech2
lpc_error2 = filter(a2,1,speech2_frame);

% Synthesize speech1 using speech2's LPC coefficients and speech1's LPC error signal
resynthesized1 = zeros(length(speech1),1);
for n = 1:overlap_samples:length(speech1)-frame_length_samples+1
    
    % Extract frame of speech1
    speech1_frame = speech1(n:n+frame_length_samples-1);
    
    % Generate LPC error signal from speech1 frame using speech2's LPC coefficients
    lpc_error = filter(a2,1,speech1_frame);
    
    % Save LPC error signal to appropriate location in resynthesized speech1 signal
    resynthesized1(n:n+frame_length_samples-1) = resynthesized1(n:n+frame_length_samples-1) + lpc_error;
    
end

% Synthesize speech2 using speech1's LPC coefficients and speech2's LPC error signal
resynthesized2 = zeros(length(speech2),1);
for n = 1:overlap_samples:length(speech2)-frame_length_samples+1
    
    % Extract frame of speech2
    speech2_frame = speech2(n:n+frame_length_samples-1);
    
    % Generate LPC error signal from speech1 frame using speech2's LPC coefficients
    lpc_error = filter(a1,1,speech2_frame);
    
    % Save LPC error signal to appropriate location in resynthesized speech1 signal
    resynthesized2(n:n+frame_length_samples-1) = resynthesized2(n:n+frame_length_samples-1) + lpc_error;
    
end

filename = 'synthesized1.wav';
filepath = './';

% Combine filepath and filename
fullpath = fullfile(filepath, filename);

% Write synthesized speech to WAV file
audiowrite(fullpath, resynthesized1, fs1);

filename = 'synthesized2.wav';
filepath = './';

% Combine filepath and filename
fullpath = fullfile(filepath, filename);

% Write synthesized speech to WAV file
audiowrite(fullpath, resynthesized2, fs2);
```

​	I tried to implement the requirements of the question in code. After LPC processing the speech, I synthesized speech1 using speech2's LPC coefficients and speech1's LPC error signal, and finally exported them as two wav files, but the sounds of these two files were almost inaudible.
