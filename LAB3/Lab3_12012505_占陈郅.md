# Lab3_12012505_占陈郅

### Introduction

The purposes of this lab are that

- Continue to learn MATLAB functionality for  speech processing (adjust SNR level,  spectrogram, etc.) 
- Learn to synthesis vowels with pure tones 
- Test loudness/equal loudness perception 
- Learn to test speech quality with PESQ index



### Lab results and Analysis

#### Problem 1

> Synthesize vowels using pure tones: 
>
> 1. Sample the spectral envelopes of vowels /a/ /i/  /u/ in last lab. 
> 2. Use pure-tones to synthesize vowels /a/ /i/ /u/  (with F0 150 Hz and 250 Hz for male and female  voice, respectively). 
> 3. Plot the waveforms/spectra/spectrograms of the   synthesized vowels.
> 4. Attach the wav files of synthesized vowels with  lab report.

```matlab
[y, y_up, y_down, Y, Y_up, Y_down, mag, mag_up, mag_down] = deal(zeros(fs*time, N));

for i = 1:N
    str = i+".wav";
    [y(:,i), ~] = audioread(str);
    [y_up(:, i), y_down(:,i)] = envelope(y(:,i));
    
    Y(:,i) = (fft(y(:,i)));
    Y_up(:,i) = (fft(y_up(:,i)));
    Y_down(:,i) = (fft(y_down(:,i)));

    mag(:,i) = 20 * log10(abs(Y(:,i)));
    mag_up(:,i) = 20 * log10(abs(Y_up(:,i)));
    mag_down(:,i) = 20 * log10(abs(Y_down(:,i)));
end
```

| time domain                                               | frequency domain                                          |
| --------------------------------------------------------- | --------------------------------------------------------- |
| ![11](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\11.png) | ![12](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\12.png) |

Note: When I record /a/ and /i/ there are many people around that I can not speak loudly.

Sample the spectral envelopes.

| vowel a                                                   | vowel i                                                   | vowel u                                                   |
| --------------------------------------------------------- | --------------------------------------------------------- | --------------------------------------------------------- |
| ![21](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\21.png) | ![22](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\22.png) | ![23](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\23.png) |

Mark harmonic data above. Then we have

> frequency
>
> a:  300, 602, 905, 1210, 1512
> i:   332, 653, 978, 1295, 1629
> u:  311, 608, 951, 1245, 1565
>
> magnitude
>
> a: 57.7015, 55.2682, 54.4646, 50.3639, 43.722
>
> i:  56.8667, 46.813, 39.9905, 48.7406, 38.2547
>
> u: 57.7557, 44.453, 38.123, 34.886, 29.3539

Synthesize vowels

```matlab
% 合成复合音
harmonic_mag = 10.^(harmonic_mag / 20);
t = 0:(1/(fs-1)):1;
[y_syn, Y_syn, mag_syn] = deal(zeros(fs, N));
for i = 1:N
    tone = sin(2 * pi * t' * harmonic_freq(i,:));
    tone = tone .* harmonic_mag(i,:) / max(harmonic_mag(:,i));
    y_syn(:,i) = sum(tone,2);
%     归一化
    y_syn(:,i) = y_syn(:,i) / max(y_syn(:,i));
%     FFT
    Y_syn(:,i) = (fft(y_syn(:,i)));
    mag_syn(:,i) = 20 * log10(abs(Y_syn(:,i)));

    audiowrite(("syn_"+i+".wav"), y_syn(:,i), fs)
end
```

| synthesized vowels                                        | original vowels                                           |
| --------------------------------------------------------- | --------------------------------------------------------- |
| ![31](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\31.png) | ![55](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\55.png) |

​	Only 5 harmonics are used for the synthesis, while there are more harmonics in the original audio. If we increase the number of harmonics, the time domain diagram of the synthesized vowel will be closer to the original signal.

| vowel a                                                   | vowel i                                                   | vowel u                                                   |
| --------------------------------------------------------- | --------------------------------------------------------- | --------------------------------------------------------- |
| ![33](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\33.png) | ![34](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\34.png) | ![35](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\35.png) |



#### Problem 2

> http://www.phys.unsw.edu.au/jw/hearing.html 
>
> 1. Hearing test on-line: sensitivity, and equal loudness  contour 
> 2. Screen-copy the equal loudness contour you  obtained.

![image-20230307085354751](C:\Users\M__zzZ\AppData\Roaming\Typora\typora-user-images\image-20230307085354751.png)



#### Problem 3

> Adjust signal-to-noise ratio (SNR)
>
> - E: energy, and SNR in dB scale 
> - or in MATLAB: >> SNR=20*log10(norm(sig)/norm(noise)) %% sig and noise must have the same length
>
> For mhint_01_01.wav, generate noisy speech by white noise at  5 and 0 dB SNR. 3. Equalize the energy of noisy speech to that of clean speech. 
>
> Plot the waveforms and spectra of clean speech and noisy  speech at 5 and 0 dB SNR. 
>
> Call MATLAB command to show spectrograms of clean speech  and noisy speech at 5 and 0 dB SNR.

​	Firstly, generate noisy speech by white noise at  5 and 0 dB SNR and for mhint_01_01.wav. Add white Gaussian noise to the signal at 0 and 5dB SNR.

```matlab
s_5 = awgn(y, 5, 'measured', 'dB');
s_0 = awgn(y, 0, 'measured', 'dB');
```

​	Next, equalize the energy of noisy speech to that of clean speech.

```matlab
s_5 = s_5 * norm(y) / norm(s_5);
s_0 = s_0 * norm(y) / norm(s_0);
```

​	Then, plot the waveforms and spectra of clean speech and noisy  speech at 5 and 0 dB SNR.

```matlab
figure, hold on
   plot(s_5), plot(y);
   legend("SNR=5dB", "original", 'Location','bestoutside');
   xlabel("time"), ylabel("Amp"), title("Time Domain","SNR=5dB");
hold off

figure, hold on
   plot(s_0), plot(y);
   legend("SNR=0dB", "original", Location="bestoutside");
   xlabel("time"), ylabel("Amp"), title("Time Domain","SNR=0dB");
hold off
```

|                         SNR = 5dB                         |                          SNR = 0dB                          |
| :-------------------------------------------------------: | :---------------------------------------------------------: |
| ![p3](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\p3.png) | ![p33](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\p33.png) |

​	We find that the difference between the two signal-to-noise ratios is not visible in the timedomain plot. So we use colea and draw the acoustic spectrogram to analyze the two signals.

```matlab
spectrogram(y)
spectrogram(s_0)
spectrogram(s_5)
```

| clean speech                                            | noisy speech at 0dB                                     | noisy speech at 5dB                                     |
| ------------------------------------------------------- | ------------------------------------------------------- | ------------------------------------------------------- |
| ![1](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\1.png) | ![2](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\2.png) | ![3](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\3.png) |

​	In clean speech, the distribution of the different frequency components is very clear. However, in noisy speech, many randomly distributed frequency components added to the sound spectrogram. Since the energy of the speech signal is greater than the energy of the noise, we can still distinguish the effective frequency components from the acoustic spectrogram of noisy speech. 



#### Problem 4

> Objective speech quality evaluation 
>
> 1. Add white noise to a clean speech signal  (mhint_01_01.wav) at -5, -3, -1, 1, 3, 5 dB  SNR level. 
> 2. Equalize the energy of noisy speech to that of  clean speech. 
> 3. Run PESQ code in MATLAB. 
> 4. Plot the PESQ value as a function of SNR level.

Read the file and add white noise to it.

```matlab
[y, fs] = audioread("mhint_01_01.wav");

snr = [-5, -3, -1, 1, 3, 5];
[signal] = deal(zeros(length(y), length(snr)));
for i = 1:length(snr)
    signal(:,i) = awgn(y ,snr(i));
    signal(:,i) = signal(:,i) * norm(y) / norm(signal(:,i));
    str = "mhint_01_01_"+i+".wav";
    audiowrite(str, signal(:,i), fs);
end
```

Using *pesq* to get score for different speech with noise compared to the clean speech.

```matlab
score = [0 0 0 0 0 0];
score(1) =  pesq('mhint_01_01.wav', 'mhint_01_01_1.wav')
score(2) =  pesq('mhint_01_01.wav', 'mhint_01_01_2.wav')
score(3) =  pesq('mhint_01_01.wav', 'mhint_01_01_3.wav')
score(4) =  pesq('mhint_01_01.wav', 'mhint_01_01_4.wav')
score(5) =  pesq('mhint_01_01.wav', 'mhint_01_01_5.wav')
score(6) =  pesq('mhint_01_01.wav', 'mhint_01_01_6.wav')
figure, hold on
plot(snr,score)
    legend("pesq")
    xlabel("SNR")
    ylabel("value "), title("Time Domain");
hold off
```

<img src="C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB3\4.png" alt="4" style="zoom:75%;" />

Note: The results are different for each run.



### Summary

- Pure tone is a single tone. It has two basic characteristics: pitch and loudness. The former depends mainly on the frequency and wavelength of the mechanical wave, and the latter depends mainly on the amplitude of the mechanical wave. There are few pure tones in nature, and the vowel tone is synthesized in this lab using the resonance peak as the pure tone
- SNR (Signal to Noise Ratio), also known as signal-to-noise ratio, is the ratio of the voltage of the output signal of an amplifier to the noise voltage of the simultaneous output, often expressed in decibels. The higher the SNR of the device, the less noise it produces. In general, the larger the signal-to-noise ratio, the smaller the noise mixed in the signal, the higher the sound quality of the sound playback, otherwise the opposite. matlab to generate Gaussian white noise Two functions can be applied directly, one is WGN and the other is AWGN. WGN is used to generate Gaussian white noise and AWGN is used to add Gaussian white noise to a certain signal.
- The PESQ algorithm requires a noisy attenuated signal and a raw reference signal that can provide a subjective MOS prediction for objective speech quality assessment and can be mapped to a MOS scale range, with PESQ scores ranging from -0.5 to 4.5. Higher scores indicate better speech quality.
