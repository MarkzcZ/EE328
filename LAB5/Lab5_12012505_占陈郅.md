# Lab5_12012505_占陈郅

### Introduction

The purposes of this lab are that

1. Learn to analysing speech signal with shorttime frequency analysis/spectrogram.
2. Learn the windowing effect for short-time  frequency analysis.



### Lab results and Analysis

#### Problem 1

Use the following input:

- speech files: s5.wav and vowel_iy_100hz.wav
- starting samples: 7000(for file s5.wav) and 1000(for file vowel_iy_100hz.wav)
- frame length: 40 msec for both examples

| s5.wav                                                  | vowel_iy_100hz.wav                                      |
| ------------------------------------------------------- | ------------------------------------------------------- |
| ![1](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB5\1.png) | ![2](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB5\2.png) |

Code

```matlab
figure()
q1('s5.wav',7000,40);
figure()
q1('vowel_iy_100hz.wav',1000,40);

function [ ] = q1( file_name, start_sample, frame_length )
[signal, Fs] = audioread(file_name);
L = round((Fs/1000)*frame_length);
window = hamming(L);

% plot the original signal
subplot(2,2,1);plot(signal);title('input signal');

% plot the windowed signal
signal_w = signal(start_sample:start_sample+L-1).*window;
subplot(2,2,2);plot(start_sample:start_sample+L-1,signal_w);title('windowed signal');

% plot the STFT
signal_w_s = fft(signal_w);
subplot(2,2,3);stem(abs(signal_w_s(1:round(L/2))),'Marker','none');title('STFT of windowed signal');

% plot the STFT in dB
signal_w_s_db = 20*log(abs(signal_w_s));
subplot(2,2,4);stem(signal_w_s_db(1:round(L/2)),'Marker','none');title('STFT of windowed signal in dB');

end
```



#### Problem 2

*Hamming window*

<img src="C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB5\3.png" alt="3" style="zoom: 200%;" />

*Rectangular window*

<img src="C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB5\4.png" alt="4" style="zoom:200%;" />

> Column 1 is the speech waveform.
>
> Column 2 is the speech segment and window.
>
> Column 3 is the STFT magnitude of windowed speech segment.
>
> Column 4 is the log magnitude.

​	In this case, we can see that the frequency distribution of the audio signal changes over time. We can also see that using the Hamming or Rectangular window can reduce the impact of spectrum leakage. Finally, we can see that expressing STFT as dB gives a better indication of changes in frequency distribution.

Code

```matlab
% Define the number of short-time spectral analyses to be compared
num_analyses = 4;

% Define the speech filename
filename = 's5.wav';

% Load the speech signal
[speech, fs] = audioread(filename);

% Define the starting sample within the speech array for analysis of the short-time spectrum
start_sample = 7000;

% Define the frame lengths in msec for each of the multiple analyses
frame_lengths = zeros(1, num_analyses);
for i = 1:num_analyses
    frame_lengths(i) = input(sprintf('Enter the frame length in msec for analysis %d: ', i));
end
% Perform short-time spectral analyses using a Hamming window
figure;
for i = 1:num_analyses
    % Convert frame length in msec to frame length in samples
    frame_length_samples = round(frame_lengths(i) * fs / 1000);
    
    % Define the Hamming window
    hamming_window = hamming(frame_length_samples);
    
    % Extract the speech segment for analysis
    speech_segment = speech(start_sample:start_sample+frame_length_samples-1);
    
    % Apply the Hamming window to the speech segment
    hamming_windowed_segment = speech_segment .* hamming_window;
    
    % Compute the short-time Fourier transform using the Hamming window
    stft_hamming = abs(fft(hamming_windowed_segment));
    
    % Plot the speech waveform
    subplot(num_analyses, 4, (i-1)*4+1);
    plot(speech);
    title('Speech waveform');
    
    % Plot the speech segment with window superimposed
    subplot(num_analyses, 4, (i-1)*4+2);
    plot(speech_segment);
    hold on;
    plot(hamming_window, 'r');
    title(sprintf('Hamming window(frame length=%d)', frame_lengths(i)));
    
    % Plot the magnitude of the short-time transform
    subplot(num_analyses, 4, (i-1)*4+3);
    plot(stft_hamming);
    title(sprintf('Magnitude(Hamming, frame length = %d)', frame_lengths(i)));
    
    % Plot the log magnitude of the short-time transform
    subplot(num_analyses, 4, (i-1)*4+4);
    plot(log10(stft_hamming));
    title(sprintf('Log magnitude(Hamming, frame length = %d)', frame_lengths(i)));
end

% Perform short-time spectral analyses using a rectangular window
figure;
for i = 1:num_analyses
    % Convert frame length in msec to frame length in samples
    frame_length_samples = round(frame_lengths(i) * fs / 1000);
    
    % Define the rectangular window
    rectangular_window = rectwin(frame_length_samples);
    
    % Extract the speech segment for analysis
    speech_segment = speech(start_sample:start_sample+frame_length_samples-1);
    
    % Apply the rectangular window to the speech segment
    rectangular_windowed_segment = speech_segment .* rectangular_window;
    
    % Compute the short-time Fourier transform using the rectangular window
    stft_rectangular = abs(fft(rectangular_windowed_segment));
    
    % Plot the speech waveform
    subplot(num_analyses, 4, (i-1)*4+1);
    plot(speech);
    title('Speech waveform');
    
    % Plot the speech segment with window superimposed
    subplot(num_analyses, 4, (i-1)*4+2);
    plot(speech_segment);
    hold on;
    plot(rectangular_window, 'r');
    title(sprintf('rectangular window(frame length=%d)', frame_lengths(i)));
    
    % Plot the magnitude of the short-time transform
    subplot(num_analyses, 4, (i-1)*4+3);
    plot(stft_rectangular);
    title(sprintf('Magnitude(rectangular, frame length=%d)', frame_lengths(i)));
    
    % Plot the log magnitude of the short-time transform
    subplot(num_analyses, 4, (i-1)*4+4);
    plot(log10(stft_rectangular));
    title(sprintf('Log magnitude(rectangular, frame length=%d)', frame_lengths(i)));
end
```



#### Problem 3

| dB scale / gray                                         | dB scale / color                                        |
| ------------------------------------------------------- | ------------------------------------------------------- |
| ![6](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB5\6.png) | ![5](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB5\5.png) |
| **linear scale / gray**                                 | **linear scale / color**                                |
| ![7](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB5\7.png) | ![8](C:\Users\M__zzZ\Documents\MATLAB\EE328\LAB5\8.png) |

​	In the color and gray plot we can identify the formants and their changes to the input audio signal. The color map is more convenient to observe the spectrogram than the gray map. The dB gives a better indication of changes in frequency distribution rather than linear scale. Narrowband spectrograms have higher temporal resolution so we can clearly see how the spectrum changes over time, while wideband spectrograms have higher spectral resolution so we can pinpoint formants and details in the frequency domain.

Code

```matlab
create_spectrogram('s5.wav',0,5,50,'linear',60,'C');


function [  ] = create_spectrogram( file_name, s_rate, len_narrow, len_wide, plot_scale, dyn_range, col_gry)
%s_rate : integer, minimum is 0
%len_narrow and len_wide: window length in miliseconds
%plot_scale: 'db' for dB scale, 'linear' = linear scale;
%dyn_range: desired dynamic range in dB
%col_gry: 'C' for color, 'G' for gray

[signal,Fs] = audioread(file_name);
% convert the input from ms to frame
L_n = round((Fs/1000)*len_narrow);
L_w = round((Fs/1000)*len_wide);
% generate window
window_n = hamming(L_n);
window_w = hamming(L_w);

% down sampling, if needed
if s_rate > 0
    signal = resample(signal, 1, s_rate);
end
% call the function plotSpec to generate figures for narrow and wide band
subplot(2,1,1);plotSpec(signal, Fs, window_n, plot_scale, dyn_range, col_gry);
title(sprintf('narrow-band spectrogram, window length = %d ms (%s)', len_narrow, plot_scale));
subplot(2,1,2);plotSpec(signal, Fs, window_w, plot_scale, dyn_range, col_gry);
title(sprintf('wide-band spectrogram, window length = %d ms (%s)', len_wide, plot_scale));

end

function [ ] = plotSpec(signal, Fs , window, plot_scale, dyn_range, col_gry)

[sp, F, T] = spectrogram(signal, window,round(length(window)/2),1024,Fs);% get the spectrogram
BA = 20*log10(abs(sp));% convert into dB
BA_max = max(max(BA));% find the maximum
BA(find(BA < BA_max - dyn_range)) = BA_max - dyn_range;% convert the dynamic range

% determine dB scale or log scale
if strcmp(plot_scale,'db')
    imagesc(T,F,BA);
elseif strcmp(plot_scale,'linear')
    imagesc(T,F,10.^(BA/20));
end

axis xy; % flip the Y Axis so lower frequencies are at the bottom
xlabel('time (s)');ylabel('frequency (Hz)');

% determine color or gray
if strcmp(col_gry,'C')
    t=colormap;
    colormap(1-t);
    colormap(jet);
elseif strcmp(col_gry,'G')
    t=colormap(gray);
    colormap(1-t);
end
    
end
```

